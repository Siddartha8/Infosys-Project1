<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard</title>
<style>
/* Body and overall styles */
body {
    font-family: Arial, sans-serif;
    background: #121212;
    margin: 0;
    padding: 0;
    color: #e0e0e0;
}
header {
    background: linear-gradient(90deg, #185a9d, #43cea2);
    color: white;
    padding: 15px;
    font-size: 22px;
    font-weight: bold;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.logout {
    background: #dc3545;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
}
.logout:hover {
    background: #c82333;
}

/* Navigation buttons styling */
.nav-buttons {
    text-align: center;
    margin: 20px 0;
}
.nav-buttons button {
    background: linear-gradient(90deg, #43cea2, #185a9d);
    color: white;
    border: none;
    cursor: pointer;
    margin: 0 8px;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 15px;
    transition: transform 0.2s ease, opacity 0.2s ease;
}
.nav-buttons button.active {
    border-bottom: 3px solid #fff;
    font-weight: bold;
}
.nav-buttons button:hover {
    transform: scale(1.05);
    opacity: 0.9;
}

/* Main container styling */
.container {
    max-width: 900px;
    margin: 20px auto;
    background: #1e1e1e;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.6);
}

/* Heading styles */
h2, h3 {
    text-align: center;
    margin-bottom: 20px;
    color: #43cea2;
}

/* Textarea styling */
textarea {
    width: 100%;
    height: 120px;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: none;
    resize: none;
    font-size: 15px;
    background: #2c2c2c;
    color: #e0e0e0;
}

/* Select and input styles for professionalism */
select, input[type=file], button, input[type=text], input[type=email], input[type=password] {
    padding: 12px 16px; 
    border-radius: 8px; 
    border: 1px solid #3a3a3a; 
    font-size: 16px; 
    background: #282828; 
    color: #e0e0e0;
    transition: border-color 0.2s ease, box-shadow 0.2s ease; 
}
select:focus, input[type=text]:focus, input[type=email]:focus, input[type=password]:focus {
    border-color: #43cea2; 
    box-shadow: 0 0 0 3px rgba(67, 206, 162, 0.3); 
    outline: none; 
}

/* Buttons styling */
button {
    background: linear-gradient(90deg, #43cea2, #185a9d);
    color: white;
    border: none;
    cursor: pointer;
    margin-right: 10px; 
    transition: background 0.3s ease, transform 0.2s ease, opacity 0.2s ease; 
    padding: 12px 20px; 
    border-radius: 8px; 
    font-size: 16px; 
    font-weight: bold;
    letter-spacing: 0.5px;
}
button:hover {
    transform: translateY(-2px) scale(1.01); 
    opacity: 0.95;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
}

/* Profile specific styles */
.profile-section {
    max-width: 550px; 
    margin: 30px auto; 
    padding: 30px; 
    background: #1e1e1e; 
    border-radius: 12px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.6);
}

.profile-section h2 {
    color: #43cea2; 
    font-size: 28px; 
    margin-bottom: 30px; 
}

.profile-group {
    margin-bottom: 25px; 
}

.profile-group label {
    display: block;
    margin-bottom: 8px; 
    font-weight: 600; 
    color: #e0e0e0; 
    font-size: 15px;
}

.profile-input {
    width: 100%;
    box-sizing: border-box; 
}

.profile-separator {
    border-top: 1px solid #333; 
    margin: 40px 0; 
}

.save-btn { 
    background: #28a745; 
    width: 100%; 
    margin-right: 0; 
}
.save-btn:hover {
    background: #218838;
}

.change-password-btn { 
    background: #185a9d; 
    width: 100%;
    margin-right: 0; 
}
.change-password-btn:hover {
    background: #154c86;
}

.profile-message {
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
    font-size: 15px;
}

/* Review list styling */
.review-item {
    padding: 12px;
    border-bottom: 1px solid #333;
    background: #2a2a2a;
    border-radius: 6px;
    margin-bottom: 12px;
}
/* MODIFIED STYLES for overall sentiment (Thick Color, Uppercase, No Braces) */
.review-item p:first-child {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}
.overall-sentiment {
    font-weight: 900; /* Very bold */
    font-size: 0.9em;
    padding: 4px 8px;
    border-radius: 4px;
    margin-left: 15px;
    flex-shrink: 0;
    align-self: flex-start;
    text-transform: uppercase; /* CAPITAL LETTERS */
}
.overall-sentiment.positive {
    background-color: #43cea2; /* Solid primary green */
    color: #000000; /* Black text for high contrast */
}
.overall-sentiment.negative {
    background-color: #dc3545; /* Solid primary red */
    color: #ffffff; /* White text for high contrast */
}
.overall-sentiment.neutral {
    background-color: #ffc107; /* Solid primary amber/yellow */
    color: #000000; /* Black text for high contrast */
}
/* END MODIFIED STYLES */

.review-meta {
    font-size: 13px;
    color: #aaa;
}
.aspect-tag {
    display: inline-block;
    margin: 2px 4px 2px 0;
    padding: 3px 7px;
    border-radius: 6px;
    font-size: 0.85em;
    font-weight: 600;
}
.aspect-tag.positive {
    background-color: rgba(40,167,69,0.15);
    color: #28a745;
}
.aspect-tag.negative {
    background-color: rgba(220,53,69,0.15);
    color: #dc3545;
}
.aspect-tag.neutral {
    background-color: rgba(108,117,125,0.15);
    color: #6c757d;
}

/* Settings panel styles */
.settings-panel {
    display: none;
    margin: 20px auto;
    padding: 15px;
    border-radius: 10px;
    background: #2a2a2a;
    text-align: center;
    max-width: 400px;
}

/* Light theme override, optional */
.light-theme {
    background: #f4f4f4 !important;
    color: #222 !important;
}
.light-theme .container {
    background: #fff !important;
    color: #222;
}
.light-theme textarea, .light-theme select, .light-theme input[type=file] {
    background: #eee !important;
    color: #222 !important;
}

/* Hide tab contents by default, show active */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Table styles for reports */
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}
table th, table td {
    border: 1px solid #333;
    padding: 10px;
    text-align: center;
}
table th {
    background: #2c2c2c;
}

/* Buttons for report download */
.btn-report {
    display: inline-block;
    padding: 10px 20px;
    margin: 10px;
    background-color: #28a745;
    color: white;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    transition: background-color 0.3s ease;
}
.btn-report:hover {
    background-color: #218838;
}

/* Summary sections */
.aggregated-summary {
    margin-top: 30px;
    background: #2a2a2a;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 6px #000a;
}
.aggregated-summary h3 {
    text-align: center;
    margin-bottom: 20px;
}
.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 15px;
}
.summary-label {
    font-weight: 600;
}

/* Charts row layout */
.charts-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    gap: 20px;
    margin-top: 20px;
}
.chart-box {
    flex: 1 1 45%;
    min-width: 300px;
    max-width: 500px;
}

/* Metrics Summary */
.metrics-summary {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px; 
    margin-top: 10px;
}

.metric-box {
    background: #2a2a2a; 
    padding: 15px 25px;
    border-radius: 8px;
    text-align: center;
    min-width: 200px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

.metric-box h4 {
    margin: 0 0 5px 0;
    color: #43cea2; 
    font-size: 16px;
    font-weight: 500;
}

.metric-box p.count {
    margin: 0;
    font-size: 28px;
    font-weight: bold;
    color: #e0e0e0;
}
</style>
</head>
<body>
<header>
<div>Welcome, {{ user.username }} ({{ user.email }})</div>
<button class="logout" onclick="window.location.href='{{ url_for('logout') }}'">Logout</button>
</header>

<div class="nav-buttons">
<button id="btnSubmit" class="active" onclick="showTab('submitTab')">Submit Review</button>
<button id="btnAnalytics" onclick="showTab('analyticsTab')">Analytics</button>
<button id="btnReviews" onclick="showTab('reviewsTab')">Reviews</button>
<button id="btnProfile" onclick="showTab('profileTab')">User Profile</button>
<button id="btnSettings" onclick="showTab('settingsTab')">Settings</button>
</div>

<div class="container">
<div id="submitTab" class="tab-content active">
<h2>Submit Your Review</h2>
<form id="reviewForm" method="POST" enctype="multipart/form-data" onsubmit="return validateReviewForm()">
<textarea id="reviewText" name="review_text" placeholder="Write your review here..."></textarea>
<label for="rating">Rating:</label>
<select id="reviewRating" name="rating">
<option value="1">⭐</option>
<option value="2">⭐⭐</option>
<option value="3">⭐⭐⭐</option>
<option value="4">⭐⭐⭐⭐</option>
<option value="5">⭐⭐⭐⭐⭐</option>
</select><br><br>
<label for="csv_file">Or Upload Reviews CSV (Format: text,rating)</label><br>
<input type="file" name="csv_file" id="csvFile" accept=".csv" /><br><br>
<div id="reviewError" style="color: #dc3545; font-weight: bold; margin-bottom: 15px;"></div>
<button type="submit">Submit</button>
</form>
</div>

<div id="analyticsTab" class="tab-content">

<div class="metrics-summary">
    <div class="metric-box">
        <h4>Reviews Submitted</h4>
        <p class="count">{{ user_reviews_submitted }}</p>
    </div>
    <div class="metric-box">
        <h4>Reviews Analyzed</h4>
        <p class="count">{{ total_reviews_analyzed }}</p>
    </div>
</div>

<div style="text-align: center; margin-bottom: 20px;">
<a href="{{ url_for('generate_report') }}" class="btn-report">Download CSV Report</a>
<a href="{{ url_for('generate_pdf_report') }}" class="btn-report">Download PDF Report</a>
</div>
<h2>Analytics Overview</h2>
<table>
<thead>
<tr>
<th>Sentiment</th>
<th>Count</th>
<th>Percentage</th>
</tr>
</thead>
<tbody>
{% set total = user_pos_count + user_neg_count + user_neu_count %}
<tr>
<td>Positive</td>
<td>{{ user_pos_count }}</td>
<td>{{ (user_pos_count / total * 100)|round(1) }}%</td>
</tr>
<tr>
<td>Negative</td>
<td>{{ user_neg_count }}</td>
<td>{{ (user_neg_count / total * 100)|round(1) }}%</td>
</tr>
<tr>
<td>Neutral</td>
<td>{{ user_neu_count }}</td>
<td>{{ (user_neu_count / total * 100)|round(1) }}%</td>
</tr>
<tr style="font-weight:bold; background:#2c2c2c;">
<td>Total</td>
<td>{{ total }}</td>
<td>100%</td>
</tr>
</tbody>
</table>

<div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
    <div>
    <label for="predefinedRange">Date Range:</label>
    <select id="predefinedRange" onchange="setPredefinedRange()">
      <option value="overall">Overall</option>
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="last7">Last 7 Days</option>
      <option value="last15">Last 15 Days</option>
      <option value="lastMonth">Last Month</option>
    </select>
  </div>
</div>
<div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
  <div style="display:flex; flex-direction:column; align-items:flex-start;">
    <label for="startDate" style="margin-bottom:4px;">Start Date:</label>
    <input style="padding:8px; border-radius:6px; border:none; background:#2c2c2c; color:#e0e0e0; font-size:15px; width:150px;" type="date" id="startDate" onchange="updateCharts()" />
  </div>
  <div style="display:flex; flex-direction:column; align-items:flex-start;">
    <label for="endDate" style="margin-bottom:4px;">End Date:</label>
    <input style="padding:8px; border-radius:6px; border:none; background:#2c2c2c; color:#e0e0e0; font-size:15px; width:150px;" type="date" id="endDate" onchange="updateCharts()" />
  </div>
</div>

<div class="charts-row">
    <div class="chart-box">
    <div style="text-align:center; margin: 32px auto; background:#2a2a2a; padding: 22px; border-radius: 12px; box-shadow: 0 2px 6px #000a;">
      <canvas id="userSentimentChart" style="max-width:220px; max-height:220px; margin:auto;"></canvas>
      <p><strong>Positive:</strong> {{ user_pos_count }} | <strong>Negative:</strong> {{ user_neg_count }} | <strong>Neutral:</strong> {{ user_neu_count }}</p>
    </div>
  </div>
    <div class="chart-box">
    <div style="text-align:center; margin: 32px auto; background:#2a2a2a; padding: 22px; border-radius: 12px; box-shadow: 0 2px 6px #000a;">
      <canvas id="sentimentTrendChart" style="width:100%; height:300px;"></canvas>
      <p style="text-align:center;"><strong>Sentiment Trend Over Time</strong></p>
    </div>
    </div>
</div>

<div style="margin-top:30px; background:#2a2a2a; padding:20px; border-radius:12px;">
<h3>Aspect Sentiment Analysis</h3>
<canvas id="aspectSentimentChart" style="width:100%; height:300px;"></canvas>
</div>

<div class="aggregated-summary" style="margin-top:30px;">
<h3>Top 5 Positive Aspects</h3>
<ul>
{% for asp in top_positive_aspects %}
    <li>{{ asp.aspect }} ({{ asp.positive }})</li>
{% else %}
    <li>No positive aspects found.</li>
{% endfor %}
</ul>

<h3>Top 5 Negative Aspects</h3>
<ul>
{% for asp in top_negative_aspects %}
    <li>{{ asp.aspect }} ({{ asp.negative }})</li>
{% else %}
    <li>No negative aspects found.</li>
{% endfor %}
</ul>
</div>

<div class="aggregated-summary">
<h3>Aspect-Based Summary</h3>
<div class="summary-item">
<div class="summary-label">Total Mentions:</div>
<div id="totalMentions">{{ total_aspect_mentions }}</div>
</div>
<div class="summary-item">
<div class="summary-label">Unique Aspects:</div>
<div id="uniqueAspects">{{ unique_aspects }}</div>
</div>
{% for asp in aspect_details %}
<div class="summary-item">
<div class="summary-label">{{ asp.aspect }}:</div>
<div>
Pos: {{ asp.positive }} | Neg: {{ asp.negative }} | Neu: {{ asp.neutral }}
</div>
</div>
{% endfor %}
</div>
</div>

<div id="reviewsTab" class="tab-content">
<h3>Your Reviews</h3>
{% for r in reviews %}
<div class="review-item">
<p>
    {{ r.text }}
    <span class="overall-sentiment {{ r.overall_sentiment|lower }}">
        {{ r.overall_sentiment }}
    </span>
</p>
<p>
{% if r.aspects %}
{% for asp in r.aspects %}
<span class="aspect-tag {{ asp.label|lower }}">{{ asp.aspect }} ({{ asp.label }})</span>
{% endfor %}
{% else %}
<span class="aspect-tag neutral">No Aspects</span>
{% endif %}
</p>
<p class="review-meta">By: {{ user.username }} | Rating: {{ r.rating }} | {{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
</div>
{% endfor %}
</div>

<div id="profileTab" class="tab-content">
    <div class="profile-section">
        <h2>Profile Details</h2>
        <form onsubmit="return updateProfile(event)">
            <div class="profile-group">
                <label for="profileUsername">Username:</label>
                <input type="text" id="profileUsername" class="profile-input" value="{{ user.username }}" required>
            </div>
            
            <div class="profile-group">
                <label for="profileEmail">Email:</label>
                <input type="email" id="profileEmail" class="profile-input" value="{{ user.email }}" required>
            </div>
            
            <button type="submit" class="save-btn">Save Profile Details</button>
        </form>

        <div class="profile-separator"></div>

        <h2>Change Password</h2>
        <form onsubmit="return changePassword(event)">
            <div class="profile-group">
                <label for="profileCurrentPassword">Current Password:</label>
                <input type="password" id="profileCurrentPassword" class="profile-input" placeholder="Enter current password (required for security)">
            </div>
            <div class="profile-group">
                <label for="profilePassword">New Password:</label>
                <input type="password" id="profilePassword" class="profile-input" placeholder="Enter new password (min 6 characters)">
            </div>
            <div class="profile-group">
                <label for="profileConfirmPassword">Confirm New Password:</label>
                <input type="password" id="profileConfirmPassword" class="profile-input" placeholder="Confirm new password">
            </div>
            <button type="submit" class="change-password-btn">Change Password</button>
        </form>
        <p id="profileMessage" class="profile-message"></p>
    </div>
</div>

<div id="settingsTab" class="tab-content">
<h2>Settings</h2>
<div class="settings-panel" style="display:block">
<button onclick="toggleTheme()">Change Theme</button>
<button onclick="location.reload()">Refresh Data</button>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// State for charts
let chartDrawn = false;

// Tab switcher
function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => { el.classList.remove('active'); el.style.display='none'; });
    document.getElementById(tab).classList.add('active');
    document.getElementById(tab).style.display='block';

    document.querySelectorAll('.nav-buttons button').forEach(btn => btn.classList.remove('active'));
    if (tab === 'submitTab') document.getElementById('btnSubmit').classList.add('active');
    if (tab === 'analyticsTab') {
        document.getElementById('btnAnalytics').classList.add('active');
        if (!chartDrawn) { drawCharts(); chartDrawn = true; }
    }
    if (tab === 'reviewsTab') document.getElementById('btnReviews').classList.add('active');
    if (tab === 'profileTab') document.getElementById('btnProfile').classList.add('active'); 
    if (tab === 'settingsTab') document.getElementById('btnSettings').classList.add('active');
}

function toggleTheme() {
    document.body.classList.toggle("light-theme");
}

// Data from backend
const userPos = {{ user_pos_count }};
const userNeg = {{ user_neg_count }};
const userNeu = {{ user_neu_count }};

const trendLabels = {{ trend_labels|tojson }};
const trendPositive = {{ trend_positive|tojson }};
const trendNegative = {{ trend_negative|tojson }};
const trendNeutral = {{ trend_neutral|tojson }};

const aspectLabels = {{ aspect_labels|tojson }};
const aspectPos = {{ aspect_pos|tojson }};
const aspectNeg = {{ aspect_neg|tojson }};
const aspectNeu = {{ aspect_neu|tojson }};

// Draw charts
function drawCharts() {
    // Distribution Chart
    var ctx = document.getElementById('userSentimentChart').getContext('2d');
    window.sentimentChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Positive', 'Negative', 'Neutral'],
            datasets: [{
                data: [userPos, userNeg, userNeu],
                backgroundColor: [
                    'rgba(40,167,69,0.9)',
                    'rgba(220,53,69,0.9)',
                    'rgba(108,117,125,0.9)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { text: 'Your Sentiment Distribution', color: '#e0e0e0', display: true }
            }
        }
    });

    // Trend Chart
    const ctxTrend = document.getElementById('sentimentTrendChart').getContext('2d');
    window.sentimentTrendChartInstance = new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [
                { label: 'Positive', data: trendPositive, borderColor: 'rgba(40,167,69,1)', backgroundColor: 'rgba(40,167,69,0.2)', fill: true, tension: 0.3 },
                { label: 'Negative', data: trendNegative, borderColor: 'rgba(220,53,69,1)', backgroundColor: 'rgba(220,53,69,0.2)', fill: true, tension: 0.3 },
                { label: 'Neutral', data: trendNeutral, borderColor: 'rgba(108,117,125,1)', backgroundColor: 'rgba(108,117,125,0.2)', fill: true, tension: 0.3 }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Sentiment Trend Over Time', color: '#e0e0e0' },
                legend: { labels: { color: '#e0e0e0' } }
            },
            scales: {
                x: { ticks: { color: '#e0e0e0' } },
                y: { ticks: { color: '#e0e0e0' }, beginAtZero: true }
            }
        }
    });

    // Aspect Sentiment Bar Chart
    const ctxAspect = document.getElementById('aspectSentimentChart').getContext('2d');
    window.aspectSentimentChartInstance = new Chart(ctxAspect, {
        type: 'bar',
        data: {
            labels: aspectLabels,
            datasets: [
                { label: 'Positive', data: aspectPos, backgroundColor: 'rgba(40,167,69,0.8)' },
                { label: 'Negative', data: aspectNeg, backgroundColor: 'rgba(220,53,69,0.8)' },
                { label: 'Neutral', data: aspectNeu, backgroundColor: 'rgba(108,117,125,0.8)' }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Aspect-Based Sentiment', color: '#e0e0e0' },
                legend: { labels: { color: '#e0e0e0' } }
            },
            scales: {
                x: { ticks: { color: '#e0e0e0' } },
                y: { ticks: { color: '#e0e0e0' }, beginAtZero: true }
            }
        }
    });
}

// Function to set predefined date ranges
function setPredefinedRange() {
    const range = document.getElementById('predefinedRange').value;
    const today = new Date();
    let start = new Date();
    let end = new Date();

    // Reset date inputs
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';

    switch(range) {
        case 'overall':
            // No date filter
            break;
        case 'today':
            start = end = today;
            break;
        case 'yesterday':
            start = new Date(today);
            start.setDate(today.getDate() - 1);
            end = start;
            break;
        case 'last7':
            start = new Date(today);
            start.setDate(today.getDate() - 6);
            end = today;
            break;
        case 'last15':
            start = new Date(today);
            start.setDate(today.getDate() - 14);
            end = today;
            break;
        case 'lastMonth':
            start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            end = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
    }
    // Set date inputs
    if (range !== 'overall') {
        document.getElementById('startDate').value = start.toISOString().slice(0,10);
        document.getElementById('endDate').value = end.toISOString().slice(0,10);
    }
    updateCharts();
}

// Main update function
function updateCharts() {
    const startDateStr = document.getElementById('startDate').value;
    const endDateStr = document.getElementById('endDate').value;

    const startDate = startDateStr ? new Date(startDateStr) : null;
    const endDate = endDateStr ? new Date(endDateStr) : null;

    const filteredLabels = [];
    const filteredPos = [];
    const filteredNeg = [];
    const filteredNeu = [];

    for (let i=0; i<trendLabels.length; i++) {
        const dateStr = trendLabels[i];
        const dateObj = new Date(dateStr);
        // Date filtering
        if (startDate && dateObj < startDate) continue;
        if (endDate && dateObj > endDate) continue;

        // Collect data
        filteredLabels.push(dateStr);
        filteredPos.push(trendPositive[i]);
        filteredNeg.push(trendNegative[i]);
        filteredNeu.push(trendNeutral[i]);
    }

    // Destroy previous trend chart
    if (window.sentimentTrendChartInstance) {
        window.sentimentTrendChartInstance.destroy();
    }

    // Draw new trend chart
    const ctxTrend = document.getElementById('sentimentTrendChart').getContext('2d');
    window.sentimentTrendChartInstance = new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: filteredLabels,
            datasets: [
                { label: 'Positive', data: filteredPos, borderColor: 'rgba(40,167,69,1)', backgroundColor: 'rgba(40,167,69,0.2)', fill: true, tension: 0.3 },
                { label: 'Negative', data: filteredNeg, borderColor: 'rgba(220,53,69,1)', backgroundColor: 'rgba(220,53,69,0.2)', fill: true, tension: 0.3 },
                { label: 'Neutral', data: filteredNeu, borderColor: 'rgba(108,117,125,1)', backgroundColor: 'rgba(108,117,125,0.2)', fill: true, tension: 0.3 }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Sentiment Trend Over Time', color: '#e0e0e0' },
                legend: { labels: { color: '#e0e0e0' } }
            },
            scales: {
                x: { ticks: { color: '#e0e0e0' } },
                y: { ticks: { color: '#e0e0e0' }, beginAtZero: true }
            }
        }
    });
}

// ------------------------------------
// NEW VALIDATION FUNCTION
// ------------------------------------
function validateReviewForm() {
    const reviewText = document.getElementById('reviewText').value.trim();
    const csvFile = document.getElementById('csvFile').files[0];
    const errorElement = document.getElementById('reviewError');
    errorElement.textContent = ''; // Clear previous error

    // 1. Check if both text and CSV are empty
    if (!reviewText && !csvFile) {
        errorElement.textContent = 'Please enter a review in the text box OR upload a CSV file.';
        return false;
    }

    // 2. Check for invalid file type
    if (csvFile) {
        // Simple check: get the file name, convert to lowercase, and check the ending
        const fileName = csvFile.name.toLowerCase();
        if (!fileName.endsWith('.csv')) {
            errorElement.textContent = 'Invalid file type. Please upload a **.csv** file.';
            // Also, clear the file input for a cleaner retry
            document.getElementById('csvFile').value = '';
            return false;
        }
    }

    // If we reach here, either valid text OR a valid file is present.
    return true;
}

// ------------------------------------
// PROFILE MANAGEMENT FUNCTIONS
// ------------------------------------

// Function to handle username/email update
function updateProfile(event) {
    event.preventDefault(); 

    const username = document.getElementById('profileUsername').value;
    const email = document.getElementById('profileEmail').value;
    const messageElement = document.getElementById('profileMessage');

    messageElement.textContent = 'Saving details...';
    messageElement.style.color = '#43cea2';

    fetch('{{ url_for("update_profile") }}', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username: username, email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageElement.textContent = 'Profile details updated successfully! Please refresh the page to update the header.';
            messageElement.style.color = '#28a745';
            document.querySelector('header div').textContent = `Welcome, ${data.username} (${data.email})`;
        } else {
            messageElement.textContent = 'Error: ' + data.message;
            messageElement.style.color = '#dc3545';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageElement.textContent = 'An unexpected error occurred.';
        messageElement.style.color = '#dc3545';
    });
    
    return false; 
}

// Function to handle password change
function changePassword(event) {
    event.preventDefault(); 

    const currentPassword = document.getElementById('profileCurrentPassword').value; 
    const newPassword = document.getElementById('profilePassword').value;
    const confirmPassword = document.getElementById('profileConfirmPassword').value;
    const messageElement = document.getElementById('profileMessage');

    if (!currentPassword) {
        messageElement.textContent = 'Please enter your current password.';
        messageElement.style.color = '#dc3545';
        return false; // Added return false
    }
    if (newPassword.length < 6) { 
        messageElement.textContent = 'New password must be at least 6 characters long.';
        messageElement.style.color = '#dc3545';
        return false; // Added return false
    }
    if (newPassword !== confirmPassword) {
        messageElement.textContent = 'New passwords do not match.';
        messageElement.style.color = '#dc3545';
        return false; // Added return false
    }

    messageElement.textContent = 'Changing password...';
    messageElement.style.color = '#43cea2';
    
    fetch('{{ url_for("change_password") }}', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            current_password: currentPassword, 
            new_password: newPassword 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageElement.textContent = 'Password changed successfully!';
            messageElement.style.color = '#28a745';
            // Clear fields on success
            document.getElementById('profileCurrentPassword').value = ''; 
            document.getElementById('profilePassword').value = '';
            document.getElementById('profileConfirmPassword').value = '';
        } else {
            messageElement.textContent = 'Error: ' + data.message;
            messageElement.style.color = '#dc3545';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageElement.textContent = 'An unexpected error occurred while changing password.';
        messageElement.style.color = '#dc3545';
    });
    return false;
}
// ------------------------------------


// Initialize chart on page load
document.addEventListener('DOMContentLoaded', () => {
    // Only draw charts if the analytics tab is active on load
    if (document.querySelector('.tab-content.active').id === 'analyticsTab') {
        drawCharts();
        chartDrawn = true;
    }
});
</script>
</body>
</html>